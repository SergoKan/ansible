- hosts: server
  become: true
  tasks:

    - name: Update apt repo and cache
      ansible.builtin.apt: 
        update_cache: true
    
    - name: Upgrade the OS (apt-get dist-upgrade)
      ansible.builtin.apt:
        upgrade: full

    - name: Remove unused dependency packages
      ansible.builtin.apt:
        autoremove: true

    - name: Install pakages
      ansible.builtin.apt:
        name: 
          - expect
          - mc 
          - top
          - vim
        state: present
        update_cache: true

    - name: Set timezone to Europe/Moscow
      community.general.timezone:
        name: Europe/Moscow

    - name: Set locale to RU
      ansible.builtin.shell: localectl set-locale LANG=ru_RU.UTF-8
      
    - name: Set a hostname
      ansible.builtin.hostname:
        name: {{ inventory_hostname }}
        
    - name: Edit /etc/hosts
      block:
      - name: Replace a localhost entry 
        ansible.builtin.lineinfile:
          path: /etc/hosts
          search_string: '127.0.1.1'
          line: 127.0.1.1 {{ inventory_hostname }}
    
    - name: Check if a reboot is needed
      register: reboot_required_file
      stat: 
        path: /var/run/reboot-required
        get_checksum: true 
        checksum_algorithm: md5

    - name: Reboot if kernel updated
      reboot:
        msg: "Reboot initiated by Ansible for kernel updates"
        connect_timeout: 5
        reboot_timeout: 300
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: uptime
      when: reboot_required_file.stat.exists

    - name: Delete old Linia
      ansible.builtin.file:
        path: ./line.run
        state: absent

    - name: Download Linia
      get_url:
        url: https://devline.ru/count.php?c=410
        dest: ./line.run
        mode: '0755' 
         
    - name: Install Linia 
      ansible.builtin.shell: yes | sudo ./line.run

    # - name: Run Linia
    #   ansible.builtin.shell: |
    #     set timeout 5
    #     spawn /home/xman/line.run
    #     expect "Выберите язык установки (1/2):"
    #     send -- "2\r"
    #     expect "Хотите ли вы сохранить существующую конфигурацию Линии (y/n)?"
    #     send -- "y\r"
    #     expect "Всё готово для установки Линии. Продолжить (y/n)?"
    #     send -- "y\r"
    #     expect "Хорошего дня!"
    #   args:
    #     executable: /usr/bin/expect
